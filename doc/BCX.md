# bcx:FORTH # {#bcx}
@brief интерпретатор байткода для встраиваемых систем

* `bcx` -- защищенная среда выполнения пользовательских команд и
расширений, 
  - предназначена для встраивания в прошивки микроконтроллеров
низшего сегмента с объемом ОЗУ от 2 Кб.
* Для предоставления пользователю устройств на микроконтроллерах полноценной
командной оболочки была выбрана технология интерпретации байткода и язык Форт.

## байткод

Байткод -- платформенно-независимое представление программ, для выполнения которых
требуется программный интерпретатор байткода. Интерпретатор `bcx` реализует
виртуальную стековую машину, в которой каждая команда ВМ представлена в виде 
* один байт -- опкод команды
* 16-битное слово -- необязательный параметр команды

Архитектура виртуальной машины соотсветствует языку программирования Форт.

В комплекте `bcx` поставляется:
* переносимый код интеретатора байткода /ANSI C/
* кросс-компилятор байткода /С++/flex/bison/
* референсная реализация встраиваемой командной оболочки /Forth/Ragel/
* TODO: интерактивный симулятор-отладчик

### Достоинства применения байткода

* система и структура команд стековой ВМ дает
  - очень компактный интерпретируемый код
  - небольшие расходы памяти для работы программ
* простой интерпретатор легко переносить и адаптировать,
  добавляя команды специфичные для конкретного устройства и среды выполнения
* адресное пространство виртуальной машины `bcx` изолировано от адресов
  микроконтроллера, что дает повышенную стабильность:
  - пользовательский код имеет ограниченный доступ к аппаратуре
  (только через команды ввода/вывода, обслуживаемые интерпретатором байткода)
  - ошибки в байт-программах не приводят к сбоям работы основной прошивки написанной на Си
  - удаленная загрузка программ не приводит к порче прошивки (приложения IoT)
* программная интерпретация позволяет реализовывать любые фишки
  виртуализированной платформы: многозадачность, защита памяти,
  событийная асинхронная архитуктура, кластеринг и распределенные вычисления,..
  
### Недостатки

* потеря скорости и ресурсов на интерпретации
  - некритично, так как байткод предполагается для реализации командного интерфейса,
    и некритичных мелких пользовательских расширений
  - узкие места всегда можно перенести в основную прошивку, написан на Си, и
    определив дополнительные пользовательские команды виртуальной машины
* изолированное адресное пространство ВМ
  - требует использования специальных команд абсолютного доступа к памяти платформы
  - это самый неудачный вариант: прямой доступ разрушает защиту основной прошивки от сбоев,
    используйте специализированные команды на Си, контролирующие правильность параметров
* использование птичьего языка программирования
  - реализация компилятора Си для стековой машины -- задача нетривиальная,
    последние 20 лет все усилия тратились на разработку методов оптимизации для RISC,
    компилятор возможен но байткод будет лапшеобразным
  
## интерактивный симулятор-отладчик

Переносимый интерпретатор может быть собран для любого типа компьютера,
имеющего станандартный компилятор Си, в том числе и для desktop-систем Windows/Linux/MacOS/...
При некотором желании можно его портировать для запуска программ на мобильных устройствах Android/iOS,
написав интерпретатор байткода на Java и добавив дополнительные команды для GUI, сети, libSDL, и т.д.
Web/JavaScript -- аналогично, с запуском байткода в браузере пользователя,
или на устройстве в комплекте со всраиваемым веб-сервером (написанным на Форте 8-)

TODO: для отладки программ написать интерактивный симулятор-отладчик с GUI,
или реализовать поддержку `gdb`

## язык Форт (нестандартный)

* [Начальный курс программирования на языке Форт](https://github.com/ponyatov/bcx/releases/download/240419/sf.pdf)
Лео Броуди
М.: "Финансы и статистика" 1990
* [Язык Форт и его реализации](https://github.com/ponyatov/bcx/releases/download/240419/baranov.pdf)
Баранов, Ноздрунов
Ленинград: "Машиностроение" 1988

## обеспечение совместимости с другими командными протоколами

Если устройство должно обеспечивать работу команд других протоколов, передаваемых
по тому же коммуникационному каналу (MODBUS RTU,..)
* для выделения команд на Форте следует использовать символ `$` передаваемый первым символом команды
* для обеспечения работы в полудуплексе переключение Rx/Tx выполняется перед обработкой команды

## система команд `bcx`

|| мнемоника | опкод | параметр | стек | |
|-|-|-|-|-|-|
| op_NOP | nop | 0x00 | | ( -- ) | нет операции |
| op_BYE | bye | 0xFF | | ( retcode -- ) | останов программы |
| op_JMP | jmp | 0x01 | addr | ( -- ) | безусловный переход |
| op_qJMP | qjmp | 0x02 | addr | ( false -- ) | словный переход по false |
| op_CALL | call | 0x03 | addr | (R: -- addr ) | вложенный вызов |
| op_RET | ret | 0x04 | | (R: addr -- ) | возврат |
| op_LIT | lit | 0x05 | int | ( -- int ) | числовой литерал (поместить константу в стек) |
